<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Stream Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-gray-100 flex flex-col items-center min-h-screen">
    <!-- ASCII Art Header -->
    <div class="ascii-art text-center mb-4 mt-4">
        <pre class="text-xl font-mono text-gray-700">
╔══════════════════════════════════════════════════════════════════════════════════╗
║  ████████╗███████╗███╗   ███╗██╗    ██████╗  ██████╗ ██████╗  ██████╗ ████████╗  ║
║  ╚══██╔══╝██╔════╝████╗ ████║██║    ██╔══██╗██╔═══██╗██╔══██╗██╔═══██╗╚══██╔══╝  ║
║     ██║   █████╗  ██╔████╔██║██║    ██████╔╝██║   ██║██████╔╝██║   ██║   ██║     ║
║     ██║   ██╔══╝  ██║╚██╔╝██║██║    ██╔══██╗██║   ██║██╔══██╗██║   ██║   ██║     ║
║     ██║   ███████╗██║ ╚═╝ ██║██║    ██║  ██║╚██████╔╝██████╔╝╚██████╔╝   ██║     ║
║     ╚═╝   ╚══════╝╚═╝     ╚═╝╚═╝    ╚═╝  ╚═╝ ╚═════╝ ╚═════╝  ╚═════╝    ╚═╝     ║
╚══════════════════════════════════════════════════════════════════════════════════╝
        </pre>
    </div>

    <!-- Stream and Status Container -->
    <div class="w-7/12 p-4 bg-white rounded shadow">
        <img src="{{ url_for('video_feed') }}" alt="Video Stream" class="w-full h-auto" width="640" height="480">
        <div class="mt-2 text-center">
            <p class="text-lg">Stream: <span id="stream_status">{{ stream_status }}</span></p>
            <p class="text-sm text-gray-600">Last Frame: <span id="last_frame_time">{{ last_frame_time }}</span></p>
        </div>
    </div>

    <!-- Sensor Data Container -->
    <div class="w-7/12 p-4 mt-4 bg-blue-100 rounded shadow text-center">
        <h2 class="text-xl font-semibold">Sensor Data</h2>
        <p class="text-sm text-gray-600">Timestamp: <span id="sensor_timestamp">-</span></p>
        <div class="h-[300px] w-full overflow-x-auto">
            <canvas id="sensorChart"></canvas>
        </div>
    </div>

    <!-- Recording Buttons -->
    <div class="w-7/12 p-4 mt-4 bg-white rounded shadow text-center">
        <button id="start-recording" class="bg-green-500 text-white px-4 py-2 rounded mr-2 hover:bg-green-600">
            Start Recording
        </button>
        <button id="stop-recording" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
            Stop Recording
        </button>
        <p id="recording-status" class="mt-2 text-gray-700">Not recording.</p>
    </div>

    <!-- JavaScript -->
    <script>
        let sensorChart;

        function updateStatus() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('stream_status').innerText = data.stream_status;
                    document.getElementById('last_frame_time').innerText = data.last_frame_time;
                })
                .catch(error => console.error('Error fetching status:', error));
        }

        function createOrUpdateChart(values) {
            const ctx = document.getElementById('sensorChart').getContext('2d');
            const labels = values.map((_, i) => `#${i + 1}`);

            const data = {
                labels: labels,
                datasets: [{
                    label: 'Sensor Values',
                    data: values,
                    backgroundColor: 'rgba(59, 130, 246, 0.5)',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 1
                }]
            };

            const config = {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            ticks: {
                                maxRotation: 90,
                                minRotation: 45
                            }
                        },
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            };

            if (sensorChart) {
                sensorChart.options.animation = false; // Disable animation on update
                sensorChart.data = data;
                sensorChart.update();
            } else {
                sensorChart = new Chart(ctx, config); // Will animate first time
            }
        }

        function updateSensorData() {
            fetch('/get-latest-sensor-data')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('sensor_timestamp').innerText = data.timestamp || "-";
                    if (data.data && Array.isArray(data.data)) {
                        const cleanedValues = data.data.map(v => parseFloat(v)).filter(v => !isNaN(v));
                        createOrUpdateChart(cleanedValues);
                    }

                })
                .catch(error => console.error('Error fetching sensor data:', error));
        }

        document.getElementById('start-recording').onclick = () => {
            fetch('/start-recording', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    document.getElementById('recording-status').innerText = data.status;
                })
                .catch(e => console.error(e));
        };

        document.getElementById('stop-recording').onclick = () => {
            fetch('/stop-recording', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    document.getElementById('recording-status').innerText = data.status;
                })
                .catch(e => console.error(e));
        };

        setInterval(updateStatus, 1000);
        setInterval(updateSensorData, 1000);

        updateStatus();
        updateSensorData();
    </script>
</body>

</html>