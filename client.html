<!DOCTYPE html>
<html>

<head>
    <title>WebRTC Video Stream</title>
</head>

<body>
    <video id="localVideo" autoplay playsinline loop></video>
    <script>
        const videoElement = document.getElementById('localVideo');
        let peerConnection = new RTCPeerConnection();

        async function startStream() {
            const videoFile = "output.mp4";
            const stream = await fetch(videoFile)
                .then(response => response.blob())
                .then(blob => {
                    return new Promise(resolve => {
                        const video = document.createElement("video");
                        video.src = URL.createObjectURL(blob);
                        video.loop = true;
                        video.muted = true;  // Mute to allow autoplay
                        video.onloadedmetadata = () => {
                            video.play();
                            resolve(video.captureStream());
                        };
                    });
                });

            if (!stream || stream.getTracks().length === 0) {
                console.error("Failed to capture stream from video.");
                return;
            }

            videoElement.srcObject = stream;

            console.log("Stream captured:", stream.getTracks().map(t => t.kind));
        }



        async function connect() {
            try {
                const stream = videoElement.srcObject;
                if (!stream || stream.getTracks().length === 0) {
                    console.error("No media tracks found! Cannot create WebRTC connection.");
                    return;
                }

                stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));

                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);

                const response = await fetch('http://localhost:5000/offer', {
                    method: 'POST',
                    body: JSON.stringify({ sdp: offer.sdp, type: offer.type }),
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    console.error("Server returned error:", await response.text());
                    return;
                }

                const answer = await response.json();
                if (!answer.sdp || !answer.type) {
                    console.error("Invalid SDP response from server:", answer);
                    return;
                }

                await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
            } catch (error) {
                console.error("Error in WebRTC connection:", error);
            }
        }


        async function init() {
            await startStream();  // Ensure stream starts before connecting
            setTimeout(connect, 1000);  // Delay to allow tracks to load
        }

        init();

    </script>
</body>

</html>